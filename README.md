# QuestDB Type Coercion Investigation

このリポジトリは、時系列データベース QuestDB におけるデータ型強制（Type Coercion）の挙動を、異なるデータ挿入プロトコル（PostgreSQL、HTTP、InfluxDB）で調査することを目的としています。特に、データ型が不一致なデータを挿入しようとした際に、各プロトコルがどのように振る舞うかを検証し、その結果をまとめます。

---

QuestDB は、データの読み書きや管理のために複数のプロトコルと、それぞれに対応するポートを公開しています。ここでは主要な 3 つのプロトコルについてまとめます。

### HTTP REST API

Web ブラウザや `curl` などの HTTP クライアントから QuestDB を操作するための API です。Web コンソールもこのポートで提供されます。

-   **デフォルトポート**: `9000`
-   **主な用途**:
    -   `curl` を使ったクエリの実行（`/exec` エンドポイント）
    -   CSV ファイルなどの一括インポート（`/imp` エンドポイント）
    -   Web ブラウザからの Web コンソールへのアクセス

### PostgreSQL ワイヤプロトコル

PostgreSQL と互換性のあるプロトコルで、SQL クエリを実行するために使用します。

-   **デフォルトポート**: `8812`
-   **主な用途**:
    -   `psql` コマンドラインツールからの接続
    -   各種プログラミング言語の PostgreSQL データベースドライバ（`psycopg2`, `asyncpg` など）を利用したアプリケーションからの接続
    -   BI ツールからのデータ参照

### InfluxDB ラインプロトコル

InfluxDB と互換性のあるプロトコルで、時系列データを高速に書き込むために特化しています。

-   **デフォルトポート**: `9009`
-   **主な用途**:
    -   Telegraf などのデータ収集エージェントからのメトリクス書き込み
    -   センサーデータやログなどのストリーミングデータを高スループットで取り込む

---

## 書き込みの挙動

### 1. PostgreSQL プロトコル

-   **挙動:** データ型が不一致なデータを挿入しようとすると、`psycopg2.Error: inconvertible value` のような例外をスローします。
-   **考察:** この挙動により、アプリケーションは不正なデータ挿入を即座に検知し、適切なエラーハンドリングを行うことができます。データの整合性を保つ上で最も安全なプロトコルと言えます。

### 2. InfluxDB プロトコル

-   **挙動:** データ型が不一致なデータを挿入しようとしても、例外をスローせず、**不正な行をサイレントに無視します**。
-   **考察:** この挙動は、大量のデータストリームを処理する際にパフォーマンス上の利点がある一方で、不正なデータが QuestDB に到達しなかったことをアプリケーション側で検知できないため、**データ損失のリスク**があります。挿入後にデータの存在を検証するなどの追加のチェックが必要です。

### 3. HTTP (`/imp`) プロトコル

-   **挙動:** データ型が不一致なデータを挿入しようとしても、例外をスローせず、**不正な行をサイレントに無視します**。
-   **考察:** InfluxDB プロトコルと同様に、不正なデータが QuestDB に到達しなかったことをアプリケーション側で検知できないため、**データ損失のリスク**があります。挿入後にデータの存在を検証するなどの追加のチェックが必要です。

## まとめ

QuestDB へのデータ挿入において、PostgreSQL プロトコルはデータの整合性を重視するアプリケーションに適しています。一方、InfluxDB および HTTP プロトコルは、高スループットが求められるが、データ型不一致時のサイレントな無視が許容される、またはアプリケーション側で別途検証ロジックが実装されている場合に適しています。

## セットアップと実行方法

1.  **QuestDB の起動:**
    ```bash
    docker compose up -d
    ```
2.  **依存関係のインストール:**
    ```bash
    uv sync
    ```
3.  **テストの実行:**
    ```bash
    uv run src/test_type_coercion.py
    ```
